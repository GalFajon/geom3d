<html>
    <head>
        <link rel="stylesheet" type="text/css" href="./dependencies/potree/build/potree/potree.css">
        <link rel="stylesheet" type="text/css" href="./dependencies/potree/build/libs/jquery-ui/jquery-ui.min.css">
        <link rel="stylesheet" type="text/css" href="./dependencies/potree/build/libs/openlayers3/ol.css">
        <link rel="stylesheet" type="text/css" href="./dependencies/potree/build/libs/spectrum/spectrum.css">
        <link rel="stylesheet" type="text/css" href="./dependencies/potree/build/libs/jstree/themes/mixed/style.css">

        <script src="./dependencies/potree/build/libs/jquery/jquery-3.1.1.min.js"></script>
        <script src="./dependencies/potree/build/libs/spectrum/spectrum.js"></script>
        <script src="./dependencies/potree/build/libs/jquery-ui/jquery-ui.min.js"></script>

        <script src="./dependencies/potree/build/libs/other/BinaryHeap.js"></script>
        <script src="./dependencies/potree/build/libs/tween/tween.min.js"></script>
        <script src="./dependencies/potree/build/libs/d3/d3.min.js"></script>
        <script src="./dependencies/potree/build/libs/proj4/proj4.js"></script>
        <script src="./dependencies/potree/build/libs/openlayers3/ol.js"></script>
        <script src="./dependencies/potree/build/libs/i18next/i18next.js"></script>
        <script src="./dependencies/potree/build/libs/jstree/jstree.js"></script>
        <script src="./dependencies/potree/build/potree/potree.js"></script>
        <script src="./dependencies/potree/build/libs/plasio/js/laslaz.js"></script>
    </head>

    <body>
        <div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
            <div id="potree_render_area"></div>
            <div id="potree_sidebar_container"> </div>
        </div>

        <script type="module">
            import { initialize, setView, PointcloudLayer, GeometryLayer, Line, Polygon, Point, View, Draw, Snap, Select, Modify, OverlayLayer, Overlay, IFCLayer, GeoJSON } from './geom3d.js';

            // http://127.0.0.1:5500/index.html?pointcloudUrl=https://projekti.lgb.si/WebPointCloud/RawData/DataConverted/20220219_viadukt_Bohinjska_Bela/metadata.json&DN=2022-0052
            
            let params = new URLSearchParams(document.location.search);
            let pointcloudUrl = params.get("pointcloudUrl");
            let DN = params.get("DN");

            async function main() {
                await initialize({
                    viewer: {
                        background: 'skybox'
                    }
                })

                let ptcldLayer = new PointcloudLayer({ urls: [ pointcloudUrl ] })
                let geomLayer = new GeometryLayer({ geometries: [] });

                let draw = new Draw({ layer: geomLayer, type: 'Point' });
                let del = new Select({ layer: geomLayer });

                fetch(`https://sdms.lgb.si/function/API_GetTocDN/0.json?dn=${DN}&apikey=0552BF4EC2731BFD7DE5493CA5585108B6C2711A`).then( async (response) => {
                    let features = (await response.json()).features;

                    for (let feature of features) {
                        if (feature.properties.Koda == '77') {
                            geomLayer.add(new Point(feature.coordinates, { properties: feature.properties}));
                        }
                    }

                    geomLayer.disableDepthTesting();
                })

                del.setActive(false);
                draw.setActive(false);

                let view = new View({
                    layers: [ geomLayer, ptcldLayer ],
                    interactions: [ draw, del, new Snap({ layers: [ ptcldLayer ] }) ]
                });

                del.addEventListener('selected', (e) => {
                    geomLayer.remove(e.detail.geometry);

                    let o = { features: [] };

                    for (let point of geomLayer.geometries) {
                        o.features.push({
                            properties: { Koda: '77' },
                            coordinates: point.vectors
                        });
                    }

                    fetch(`https://sdms.lgb.si/function/API_DodajTocDN/0.json?dn=${DN}&apikey=0552BF4EC2731BFD7DE5493CA5585108B6C2711A`,
                    {
                        mode: 'no-cors',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        method: "POST",
                        body: JSON.stringify(o)
                    })
                    .then(function(res){ 
                        console.log("success.");
                    })
                    .catch(function(res){ 
                        console.log(res) 
                    });
                })

                draw.addEventListener('drawend', (e) => {
                    for (let point of e.detail) geomLayer.add(point);

                    let o = { features: [] };

                    for (let point of geomLayer.geometries) {
                        o.features.push({
                            properties: { Koda: '77' },
                            coordinates: point.vectors
                        });
                    }

                    fetch(`https://sdms.lgb.si/function/API_DodajTocDN/0.json?dn=${DN}&apikey=0552BF4EC2731BFD7DE5493CA5585108B6C2711A`,
                    {
                        mode: 'no-cors',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        method: "POST",
                        body: JSON.stringify(o)
                    })
                    .then(function(res){ 
                        console.log("success");
                     })
                    .catch(function(res){ 
                        console.log(res) 
                    });
                })

                document.addEventListener('keydown', (e) => {
                    if (e.key.toUpperCase() == 'P') {
                        draw.setActive(true);
                        del.setActive(false);
                    }
                    else if (e.key.toUpperCase() == 'DELETE') {
                        draw.setActive(false);
                        del.setActive(true);
                    }
                    else if (e.key.toUpperCase() == 'ESCAPE') {
                        draw.setActive(false);
                        del.setActive(false);
                    }            
                })

                await setView(view);
                view.center();
            }

            main();
        </script>
    </body>
</html>